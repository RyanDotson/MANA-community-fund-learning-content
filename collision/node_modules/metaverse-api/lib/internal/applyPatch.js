"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
function applyPatch(tree, diffs, createEntity) {
    let length = diffs.length;
    if (length === 0) {
        return true;
    }
    for (let i = 0; i < length; i++) {
        if (!applyDiff(tree, diffs[i], createEntity)) {
            return false;
        }
    }
    return true;
}
exports.applyPatch = applyPatch;
function getNodeFromRoute(tree, route) {
    const _route = route.slice();
    let node = tree;
    while (_route.length > 0 && node) {
        let index = _route.shift();
        node = node.getChildByIndex(index);
    }
    return node;
}
function applyDiff(tree, diff, createEntity) {
    let node = getNodeFromRoute(tree, diff[types_1.Actions.route]);
    let route;
    switch (diff[types_1.Actions.action]) {
        case types_1.Actions.addAttribute:
            if (!node) {
                return false;
            }
            // do nothing, the actual change happens inside modifyAttribute
            break;
        case types_1.Actions.modifyAttribute:
            if (!node) {
                return false;
            }
            node.setAttributes({ [diff[types_1.Actions.name]]: diff[types_1.Actions.newValue] });
            break;
        case types_1.Actions.removeAttribute:
            if (!node || !node.removeAttribute) {
                return false;
            }
            node.removeAttribute(diff[types_1.Actions.name]);
            break;
        case types_1.Actions.replaceElement:
            node.replaceBy(createEntity(diff[types_1.Actions.newValue]));
            break;
        case types_1.Actions.relocateGroup:
            const nodeArray = node
                .childEntities()
                .splice(diff[types_1.Actions.from], diff[types_1.Actions.groupLength])
                .reverse();
            const target = node.getChildByIndex(diff[types_1.Actions.to]);
            for (let i = 0; i < nodeArray.length; i++) {
                node.insertAfter(nodeArray[i], target);
            }
            break;
        case types_1.Actions.removeElement:
            node.removeFromParent();
            break;
        case types_1.Actions.addElement:
            route = diff[types_1.Actions.route].slice();
            const position = route.pop();
            node = getNodeFromRoute(tree, route);
            if (node) {
                const entity = createEntity(diff[types_1.Actions.element]);
                const beforeEntity = node.getChildByIndex(position);
                if (beforeEntity) {
                    node.insertBefore(entity, beforeEntity);
                }
                else {
                    node.add(entity);
                }
            }
            else
                return false;
            break;
        default:
            // tslint:disable-next-line:no-console
            console.log('unknown action');
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHlQYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC9hcHBseVBhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXdDO0FBNER4QyxvQkFBb0IsSUFBYSxFQUFFLEtBQWMsRUFBRSxZQUFnRDtJQUNqRyxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFBO0lBRXpCLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtRQUNoQixPQUFPLElBQUksQ0FBQTtLQUNaO0lBRUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLEVBQUU7WUFDNUMsT0FBTyxLQUFLLENBQUE7U0FDYjtLQUNGO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBZ0ZpQixnQ0FBVTtBQTlFNUIsMEJBQTBCLElBQWEsRUFBRSxLQUFlO0lBQ3RELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUM1QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7SUFDZixPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRTtRQUNoQyxJQUFJLEtBQUssR0FBVyxNQUFNLENBQUMsS0FBSyxFQUFTLENBQUE7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDbkM7SUFDRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFFRCxtQkFBbUIsSUFBYSxFQUFFLElBQVcsRUFBRSxZQUFnRDtJQUM3RixJQUFJLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGVBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxD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eyBBY3Rpb25zLCBJRGlmZiB9IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBJU2ltcGxpZmllZE5vZGUgfSBmcm9tICcuLidcblxudHlwZSBJRW50aXR5PFQgZXh0ZW5kcyBJU2ltcGxpZmllZE5vZGUgPSBhbnk+ID0ge1xuICAvKipcbiAgICogUmVjZWl2ZXMgYSBkaWN0aW9uYXJ5IG9mIGF0dHJpYnV0ZXMgYW5kIHZhbHVlcy5cbiAgICogSXQgaW5pdGlhbGl6ZXMgYW5kIHVwZGF0ZXMgdGhlIGNvbXBvbmVudHMuXG4gICAqL1xuICBzZXRBdHRyaWJ1dGVzKGF0dHJzOiB7IFthdHRyTmFtZTogc3RyaW5nXTogYW55IH0pOiB2b2lkXG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYW4gYXR0cmlidXRlLCBpZiBhIGNvbXBvbmVudCBpcyBhdHRhY2hlZCB0byB0aGUgYXR0cmlidXRlLCBpdCBhbHNvIHRlYXIgZG93biB0aGUgY29tcG9uZW50LlxuICAgKi9cbiAgcmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWU6IHN0cmluZyk6IHZvaWRcblxuICAvKipcbiAgICogRGV0YWNoZXMgYSBjaGlsZHJlbiBlbnRpdHkuXG4gICAqIEl0IGRvZXMgbm90IHJlbGVhc2VzIGFsbCB0aGUgcmVzb3VyY2VzLiBUaGUgZW50aXR5IG1pZ2h0IGJlIHJlYXR0YWNoZWQgdG8gdGhlIGVudGl0eSB0cmVlLlxuICAgKi9cbiAgcmVtb3ZlKGNoaWxkRW50aXR5VG9SZW1vdmU6IFQpOiB2b2lkXG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgdGhlIGVudGl0eSBmcm9tIGl0J3MgcGFyZW50IGFuZCBhbHNvIGNsZWFucyB1cCBhbmRcbiAgICogcmVsZWFzZXMgYWxsIHRoZSByZXNvdXJjZXMgcmVjdXJzaXZlbHlcbiAgICovXG4gIHJlbW92ZUZyb21QYXJlbnQoKTogdm9pZFxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGNoaWxkcmVuIGVudGl0aWVzXG4gICAqL1xuICBjaGlsZEVudGl0aWVzKCk6IElFbnRpdHlbXVxuXG4gIC8qKlxuICAgKiBBcHBlbmRzIGFuIGVudGl0eSB0byB0aGlzIGVudGl0eS5cbiAgICogSWYgdGhlIGVudGl0eSBoYXMgYW5vdGhlciBwYXJlbnQsIGl0IGZpcnN0IHNhZmVseSByZW1vdmVzIGl0IGZyb20gaXRzIHBhcmVudC5cbiAgICovXG4gIGFkZChlbnRpdHk6IFQpOiB2b2lkXG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIG50aC1jaGlsZCBlbnRpdHlcbiAgICovXG4gIGdldENoaWxkQnlJbmRleChpbmRleDogbnVtYmVyKTogVCB8IG51bGxcblxuICAvKipcbiAgICogUmVwbGFjZXMgdGhpcyBlbnRpdHkgYnkgdGhlIG5ldyBvbmUuXG4gICAqIFRoZSBlbnRpdHkgdGhhdCBpcyByZW1vdmVkIGlzIHJlbGVhc2VkIGFuZCBjYW5ub3QgYmUgcmVhdHRhY2hlZCB0byB0aGUgZW50aXR5IHRyZWUuXG4gICAqL1xuICByZXBsYWNlQnkoZW50aXR5OiBUKTogdm9pZFxuXG4gIC8qKlxuICAgKiBGaW5kcyBhbiBlbnRpdHkgaW4gdGhpcyBlbnRpdGllcyBjaGlsZHJlbiBhbmQgaW5zZXJ0cyB0aGUgZmlyc3QgYXJndW1lbnQgYmVmb3JlIHRoZSBzZWNvbmQgb25lIChyZWZlcmVuY2UpXG4gICAqL1xuICBpbnNlcnRCZWZvcmUobmV3SXRlbTogVCwgcmVmOiBUKTogdm9pZFxuXG4gIC8qKlxuICAgKiBGaW5kcyBhbiBlbnRpdHkgaW4gdGhpcyBlbnRpdGllcyBjaGlsZHJlbiBhbmQgaW5zZXJ0cyB0aGUgZmlyc3QgYXJndW1lbnQgYWZ0ZXIgdGhlIHNlY29uZCBvbmUgKHJlZmVyZW5jZSlcbiAgICovXG4gIGluc2VydEFmdGVyKG5ld0l0ZW06IFQsIHJlZjogVCk6IHZvaWRcbn1cblxuZnVuY3Rpb24gYXBwbHlQYXRjaCh0cmVlOiBJRW50aXR5LCBkaWZmczogSURpZmZbXSwgY3JlYXRlRW50aXR5OiAobm9kZTogSVNpbXBsaWZpZWROb2RlKSA9PiBJRW50aXR5KSB7XG4gIGxldCBsZW5ndGggPSBkaWZmcy5sZW5ndGhcblxuICBpZiAobGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoIWFwcGx5RGlmZih0cmVlLCBkaWZmc1tpXSwgY3JlYXRlRW50aXR5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuZnVuY3Rpb24gZ2V0Tm9kZUZyb21Sb3V0ZSh0cmVlOiBJRW50aXR5LCByb3V0ZTogbnVtYmVyW10pOiBJRW50aXR5IHtcbiAgY29uc3QgX3JvdXRlID0gcm91dGUuc2xpY2UoKVxuICBsZXQgbm9kZSA9IHRyZWVcbiAgd2hpbGUgKF9yb3V0ZS5sZW5ndGggPiAwICYmIG5vZGUpIHtcbiAgICBsZXQgaW5kZXg6IG51bWJlciA9IF9yb3V0ZS5zaGlmdCgpIGFzIGFueVxuICAgIG5vZGUgPSBub2RlLmdldENoaWxkQnlJbmRleChpbmRleClcbiAgfVxuICByZXR1cm4gbm9kZVxufVxuXG5mdW5jdGlvbiBhcHBseURpZmYodHJlZTogSUVudGl0eSwgZGlmZjogSURpZmYsIGNyZWF0ZUVudGl0eTogKG5vZGU6IElTaW1wbGlmaWVkTm9kZSkgPT4gSUVudGl0eSkge1xuICBsZXQgbm9kZSA9IGdldE5vZGVGcm9tUm91dGUodHJlZSwgZGlmZltBY3Rpb25zLnJvdXRlXSlcbiAgbGV0IHJvdXRlOiBhbnlbXVxuXG4gIHN3aXRjaCAoZGlmZltBY3Rpb25zLmFjdGlvbl0pIHtcbiAgICBjYXNlIEFjdGlvbnMuYWRkQXR0cmlidXRlOlxuICAgICAgaWYgKCFub2RlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgLy8gZG8gbm90aGluZywgdGhlIGFjdHVhbCBjaGFuZ2UgaGFwcGVucyBpbnNpZGUgbW9kaWZ5QXR0cmlidXRlXG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5tb2RpZnlBdHRyaWJ1dGU6XG4gICAgICBpZiAoIW5vZGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgICBub2RlLnNldEF0dHJpYnV0ZXMoeyBbZGlmZltBY3Rpb25zLm5hbWVdXTogZGlmZltBY3Rpb25zLm5ld1ZhbHVlXSB9KVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMucmVtb3ZlQXR0cmlidXRlOlxuICAgICAgaWYgKCFub2RlIHx8ICFub2RlLnJlbW92ZUF0dHJpYnV0ZSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGRpZmZbQWN0aW9ucy5uYW1lXSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLnJlcGxhY2VFbGVtZW50OlxuICAgICAgbm9kZS5yZXBsYWNlQnkoY3JlYXRlRW50aXR5KGRpZmZbQWN0aW9ucy5uZXdWYWx1ZV0pKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMucmVsb2NhdGVHcm91cDpcbiAgICAgIGNvbnN0IG5vZGVBcnJheSA9IG5vZGVcbiAgICAgICAgLmNoaWxkRW50aXRpZXMoKVxuICAgICAgICAuc3BsaWNlKGRpZmZbQWN0aW9ucy5mcm9tXSwgZGlmZltBY3Rpb25zLmdyb3VwTGVuZ3RoXSlcbiAgICAgICAgLnJldmVyc2UoKVxuXG4gICAgICBjb25zdCB0YXJnZXQgPSBub2RlLmdldENoaWxkQnlJbmRleChkaWZmW0FjdGlvbnMudG9dKVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICBub2RlLmluc2VydEFmdGVyKG5vZGVBcnJheVtpXSwgdGFyZ2V0KVxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMucmVtb3ZlRWxlbWVudDpcbiAgICAgIG5vZGUucmVtb3ZlRnJvbVBhcmVudCgpXG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5hZGRFbGVtZW50OlxuICAgICAgcm91dGUgPSBkaWZmW0FjdGlvbnMucm91dGVdLnNsaWNlKClcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcm91dGUucG9wKClcbiAgICAgIG5vZGUgPSBnZXROb2RlRnJvbVJvdXRlKHRyZWUsIHJvdXRlKVxuXG4gICAgICBpZiAobm9kZSkge1xuICAgICAgICBjb25zdCBlbnRpdHkgPSBjcmVhdGVFbnRpdHkoZGlmZltBY3Rpb25zLmVsZW1lbnRdKVxuXG4gICAgICAgIGNvbnN0IGJlZm9yZUVudGl0eSA9IG5vZGUuZ2V0Q2hpbGRCeUluZGV4KHBvc2l0aW9uKVxuXG4gICAgICAgIGlmIChiZWZvcmVFbnRpdHkpIHtcbiAgICAgICAgICBub2RlLmluc2VydEJlZm9yZShlbnRpdHksIGJlZm9yZUVudGl0eSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBub2RlLmFkZChlbnRpdHkpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2VcbiAgICAgIGJyZWFrXG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmxvZygndW5rbm93biBhY3Rpb24nKVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuLy8vIC0tLSBFWFBPUlRTIC0tLVxuXG5leHBvcnQgeyBJRW50aXR5LCBhcHBseVBhdGNoIH1cbiJdfQ==